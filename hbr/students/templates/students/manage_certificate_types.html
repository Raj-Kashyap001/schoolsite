{% extends 'dashboard/layout.html' %}

{% block content %}
  <div class="certificate-types-container">
    <h1>Manage Certificate Types</h1>

    <button id="add-type-btn" class="btn btn-primary">Add New Certificate Type</button>

    <div class="certificate-types-list">
      {% for cert_type in certificate_types %}
        <div class="certificate-type-card">
          <div class="card-header">
            <h3>{{ cert_type.name }}</h3>
            <div class="card-actions">
              <button class="btn btn-sm btn-outline edit-btn" data-id="{{ cert_type.id }}" data-name="{{ cert_type.name }}" data-description="{{ cert_type.description }}" data-template="{{ cert_type.html_template|escapejs }}" data-active="{{ cert_type.is_active }}">Edit</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="{{ cert_type.id }}" data-name="{{ cert_type.name }}">Delete</button>
            </div>
          </div>
          <div class="card-body">
            <p>
              <strong>Description:</strong> {{ cert_type.description|default:'No description' }}
            </p>
            <p>
              <strong>Status:</strong>
              <span class="status-{{ cert_type.is_active|yesno:'active,inactive' }}">{{ cert_type.is_active|yesno:'Active,Inactive' }}</span>
            </p>
            {% if cert_type.html_template %}
              <details>
                <summary>HTML Template</summary>
                <pre>{{ cert_type.html_template }}</pre>
              </details>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p>No certificate types found.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="type-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modal-title">Add Certificate Type</h2>
      <form id="type-form" method="post">
        {% csrf_token %}
        <input type="hidden" id="type-id" name="type_id" value="" />
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="html_template">HTML Template</label>
          <div class="editor-toolbar">
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ student_name }}">Student Name</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ father_name }}">Father Name</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ mother_name }}">Mother Name</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ class }}">Class</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ roll_no }}">Roll No</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ admission_no }}">Admission No</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ date }}">Date</button>
            <button type="button" class="btn btn-sm btn-outline insert-placeholder" data-placeholder="{{ school_name }}">School Name</button>
          </div>
          <div id="html_template_editor"></div>
          <textarea id="html_template" name="html_template" class="hidden-textarea"></textarea>
          <small class="help-text">Use the buttons above to insert placeholders. Available placeholders:{% verbatim %}{{ student_name }}, {{ father_name }}, {{ mother_name }}, {{ class }}, {{ roll_no }}, {{ admission_no }}, {{ date }}, {{ school_name }}{% endverbatim %}</small>
        </div>
        <div class="form-group checkbox-group">
          <label><input type="checkbox" id="is_active" name="is_active" checked />Active</label>
        </div>
        <button type="submit" id="submit-btn" name="create" class="btn btn-primary">Create</button>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Delete Certificate Type</h2>
      <p>
        Are you sure you want to delete "<span id="delete-name"></span>"?
      </p>
      <form id="delete-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="type_id" id="delete-type-id" />
        <div class="modal-actions">
          <button type="submit" name="delete" class="btn btn-danger">Delete</button>
          <button type="button" class="btn btn-outline close-modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>

  <script>
    // Modal functionality
    const modal = document.getElementById('type-modal')
    const deleteModal = document.getElementById('delete-modal')
    const addBtn = document.getElementById('add-type-btn')
    const closeBtns = document.getElementsByClassName('close')
    const form = document.getElementById('type-form')
    const submitBtn = document.getElementById('submit-btn')
    const modalTitle = document.getElementById('modal-title')
    
    let editor = null
    
    // Initialize CKEditor
    ClassicEditor.create(document.querySelector('#html_template_editor'), {
      toolbar: ['heading', '|', 'bold', 'italic', 'underline', 'strikethrough', '|', 'bulletedList', 'numberedList', '|', 'alignment', '|', 'link', 'blockQuote', '|', 'undo', 'redo'],
      language: 'en'
    })
      .then((newEditor) => {
        editor = newEditor
    
        // Sync editor content to hidden textarea
        editor.model.document.on('change:data', () => {
          document.getElementById('html_template').value = editor.getData()
        })
    
        // Initialize placeholder buttons after editor is ready
        initPlaceholderButtons()
      })
      .catch((error) => {
        console.error('CKEditor initialization error:', error)
      })
    
    // Function to initialize placeholder button listeners
    function initPlaceholderButtons() {
      document.querySelectorAll('.insert-placeholder').forEach((button) => {
        button.addEventListener('click', function (e) {
          e.preventDefault()
          const placeholder = this.getAttribute('data-placeholder')
          if (editor) {
            // Get current content
            const currentData = editor.getData()
            // Insert placeholder at the end with a space
            const newData = currentData + (currentData ? ' ' : '') + placeholder + ' '
            editor.setData(newData)
    
            // Move cursor to end
            editor.editing.view.focus()
            const root = editor.model.document.getRoot()
            editor.model.change((writer) => {
              writer.setSelection(writer.createPositionAt(root, 'end'))
            })
          }
        })
      })
    }
    
    // Add button click handler
    addBtn.onclick = function () {
      resetModal()
      modal.style.display = 'block'
    }
    
    // Close button handlers
    Array.from(closeBtns).forEach((btn) => {
      btn.onclick = function () {
        modal.style.display = 'none'
        deleteModal.style.display = 'none'
      }
    })
    
    // Close modal buttons
    document.querySelectorAll('.close-modal').forEach((btn) => {
      btn.onclick = function () {
        deleteModal.style.display = 'none'
      }
    })
    
    // Click outside modal to close
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = 'none'
      }
      if (event.target == deleteModal) {
        deleteModal.style.display = 'none'
      }
    }
    
    // Reset modal function
    function resetModal() {
      form.reset()
      document.getElementById('type-id').value = ''
      if (editor) {
        editor.setData('')
      }
      document.getElementById('html_template').value = ''
      modalTitle.textContent = 'Add Certificate Type'
      submitBtn.textContent = 'Create'
      submitBtn.name = 'create'
    }
    
    // Edit functionality
    document.querySelectorAll('.edit-btn').forEach((btn) => {
      btn.onclick = function () {
        const data = this.dataset
        document.getElementById('type-id').value = data.id
        document.getElementById('name').value = data.name
        document.getElementById('description').value = data.description || ''
    
        const templateContent = data.template || ''
        document.getElementById('html_template').value = templateContent
    
        if (editor) {
          editor.setData(templateContent)
        }
    
        document.getElementById('is_active').checked = data.active === 'True'
        modalTitle.textContent = 'Edit Certificate Type'
        submitBtn.textContent = 'Update'
        submitBtn.name = 'update'
        modal.style.display = 'block'
      }
    })
    
    // Delete functionality
    document.querySelectorAll('.delete-btn').forEach((btn) => {
      btn.onclick = function () {
        const data = this.dataset
        document.getElementById('delete-name').textContent = data.name
        document.getElementById('delete-type-id').value = data.id
        deleteModal.style.display = 'block'
      }
    })
  </script>

  <style>
    .certificate-types-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .certificate-types-container h1 {
      text-align: center;
      margin-bottom: 1rem;
      margin-left: 0.5rem;
    }
    
    .certificate-types-list {
      margin-top: 20px;
    }
    
    .certificate-type-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      background: white;
    }
    
    .card-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-header h3 {
      margin: 0;
    }
    
    .card-actions {
      display: flex;
      gap: 10px;
    }
    
    .card-body {
      padding: 15px;
    }
    
    .card-body p {
      margin-bottom: 10px;
    }
    
    .status-active {
      color: green;
      font-weight: bold;
    }
    
    .status-inactive {
      color: red;
      font-weight: bold;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      border-radius: 8px;
      max-width: 800px;
      position: relative;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .checkbox-group label {
      display: flex;
      align-items: center;
      font-weight: normal;
    }
    
    .checkbox-group input[type='checkbox'] {
      margin-right: 8px;
      width: auto;
    }
    
    .form-group input[type='text'],
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .form-group textarea {
      font-family: 'Courier New', monospace;
      resize: vertical;
    }
    
    .help-text {
      display: block;
      margin-top: 5px;
      font-size: 0.9em;
      color: #666;
    }
    
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
      padding: 10px;
      background: #f8f8f8;
      border-radius: 4px;
    }
    
    .editor-toolbar button {
      font-size: 0.85em;
      padding: 5px 10px;
    }
    
    .hidden-textarea {
      display: none;
    }
    
    #html_template_editor {
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 400px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    pre {
      background: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.9em;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    details {
      margin-top: 10px;
    }
    
    summary {
      cursor: pointer;
      font-weight: bold;
      padding: 5px 0;
    }
    
    summary:hover {
      color: #0066cc;
    }
  </style>
{% endblock %}
