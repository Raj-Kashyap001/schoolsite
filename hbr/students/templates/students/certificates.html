{% extends 'dashboard/layout.html' %}

{% block content %}
  <div class="certificates-container">
    <h1>My Certificates</h1>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% else %}
      {% if available_types %}
        <div class="issue-certificate-section">
          <button id="issue-certificate-btn" class="btn btn-primary">Issue New Certificate</button>
        </div>
      {% endif %}

      <div class="certificates-tables">
        <div class="certificates-table-section">
          <h2>Issued Certificates (Pending Approval)</h2>
          {% if issued_certificates %}
            <table class="certificates-table">
              <thead>
                <tr>
                  <th>Certificate Type</th>
                  <th>Requested Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for certificate in issued_certificates %}
                  <tr>
                    <td>{{ certificate.certificate_type.name }}</td>
                    <td>{{ certificate.issued_date|date:'d/m/Y H:i' }}</td>
                    <td>
                      <span class="status-pending">{{ certificate.get_status_display }}</span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No pending certificates.</p>
          {% endif %}
        </div>

        <div class="certificates-table-section">
          <h2>My Certificates</h2>
          {% if my_certificates %}
            <table class="certificates-table">
              <thead>
                <tr>
                  <th>Certificate Type</th>
                  <th>Issued Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for certificate in my_certificates %}
                  <tr>
                    <td>{{ certificate.certificate_type.name }}</td>
                    <td>{{ certificate.issued_date|date:'d/m/Y H:i' }}</td>
                    <td>
                      {% if certificate.file %}
                        <a href="{{ certificate.file.url }}" target="_blank" class="btn btn-primary"><i class="bx bx-arrow-down-stroke-circle"></i> Download</a>
                      {% else %}
                        <span class="text-muted">Generating...</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No approved certificates yet.</p>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal for issuing certificate -->
  <div id="certificate-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Issue New Certificate</h2>
      <form method="post">
        {% csrf_token %}
        <div class="form-group">
          <label for="certificate_type">Select Certificate Type:</label>
          <select name="certificate_type" id="certificate_type" required>
            <option value="">Choose a certificate...</option>
            {% for cert_type in available_types %}
              <option value="{{ cert_type.id }}">{{ cert_type.name }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Submit Request</button>
      </form>
    </div>
  </div>

  <script>
    // Get modal elements
    var modal = document.getElementById('certificate-modal')
    var btn = document.getElementById('issue-certificate-btn')
    var span = document.getElementsByClassName('close')[0]
    
    // Open modal when button is clicked
    btn.onclick = function () {
      modal.style.display = 'block'
    }
    
    // Close modal when x is clicked
    span.onclick = function () {
      modal.style.display = 'none'
    }
    
    // Close modal when clicking outside
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = 'none'
      }
    }
  </script>
{% endblock %}
