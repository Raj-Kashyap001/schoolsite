{% extends 'dashboard/layout.html' %}

{% block content %}
  <div class="leave-container">
    <h1>Leave Applications</h1>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% else %}
      {% if role == 'Admin' %}
        <!-- Admin View - Manage Teacher Leaves -->
        <div class="admin-leave-section">
          <h2>Teacher Leave Management</h2>
          {% if all_teacher_leaves %}
            <table class="leave-table">
              <thead>
                <tr>
                  <th>Teacher</th>
                  <th>Apply Date</th>
                  <th>Reason</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for leave in all_teacher_leaves %}
                  <tr>
                    <td>{{ leave.teacher.user.get_full_name }}</td>
                    <td>{{ leave.apply_date|date:'d/m/Y H:i' }}</td>
                    <td>{{ leave.reason }}</td>
                    <td>{{ leave.from_date|date:'d/m/Y' }}</td>
                    <td>{{ leave.to_date|date:'d/m/Y' }}</td>
                    <td class="status-{{ leave.status|lower }}">{{ leave.status }}</td>
                    <td>
                      {% if leave.status == 'PENDING' %}
                        <button class="btn btn-success approve-btn" data-id="{{ leave.id }}" style="margin-right: 5px;"><i class="bx bx-check"></i> Approve</button>
                        <button class="btn btn-danger reject-btn" data-id="{{ leave.id }}"><i class="bx bx-x"></i> Reject</button>
                      {% else %}
                        <small>Approved by: {{ leave.approved_by.get_full_name|default:'N/A' }}</small>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No teacher leave requests found.</p>
          {% endif %}
        </div>
      {% else %}
        <!-- Student/Teacher View - Apply and View Own Leaves -->
        <div class="apply-leave-section">
          <button id="applyLeaveBtn" class="btn btn-primary">Apply for Leave</button>
        </div>

        <div class="leave-table-section">
          <h2>Your Leave Requests</h2>
          {% if leaves %}
            <table class="leave-table">
              <thead>
                <tr>
                  <th>Apply Date</th>
                  <th>Reason</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for leave in leaves %}
                  <tr>
                    <td>{{ leave.apply_date|date:'d/m/Y H:i' }}</td>
                    <td>{{ leave.reason }}</td>
                    <td>{{ leave.from_date|date:'d/m/Y' }}</td>
                    <td>{{ leave.to_date|date:'d/m/Y' }}</td>
                    <td class="status-{{ leave.status|lower }}">{{ leave.status }}</td>
                    <td>
                      {% if leave.status == 'PENDING' %}
                        <button class="btn btn-outline edit-btn" data-id="{{ leave.id }}"><i class="bxr bx-pencil"></i></button>
                        <button class="btn btn-inverted delete-btn" data-id="{{ leave.id }}"><i class="bxr bx-trash"></i></button>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No leave requests found.</p>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- Apply Leave Modal -->
  <div id="applyLeaveModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Apply for Leave</h2>
      <form id="applyLeaveForm">
        {% csrf_token %}
        <div class="form-group">
          <label for="reason">Reason:</label>
          <textarea id="reason" name="reason" required></textarea>
        </div>
        <div class="form-group">
          <label for="from_date">From Date:</label>
          <input type="date" id="from_date" name="from_date" required />
        </div>
        <div class="form-group">
          <label for="to_date">To Date:</label>
          <input type="date" id="to_date" name="to_date" required />
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block inline_js %}
  {% load static %}
  <script>
    const leaveUrl = "{% url 'leave:leave' %}"
  </script>
  <script src="{% static 'js/apply_leave_module.js' %}"></script>
{% endblock %}
